# Implementation Plan: Database Schema & Supabase Setup

**Branch**: `002-database-schema` | **Date**: 2026-02-09 | **Spec**: [spec.md](../../.specify/specs/002-database-schema/spec.md)
**Input**: Feature specification from `.specify/specs/002-database-schema/spec.md`

## Summary

Create the foundational database schema for HookSpy using Supabase PostgreSQL. This includes two core tables (`endpoints` and `webhook_logs`), performance indexes, row-level security policies for user data isolation, Supabase Realtime publication for instant webhook notifications, an auto-updating `updated_at` trigger, and a pg_cron scheduled job for 24-hour log cleanup. All schema objects are delivered as numbered SQL migration files in `supabase/migrations/`.

## Technical Context

**Language/Version**: SQL (PostgreSQL 15+ via Supabase)
**Primary Dependencies**: Supabase (PostgreSQL + Auth + Realtime + pg_cron)
**Storage**: Supabase PostgreSQL
**Testing**: Manual SQL validation against Supabase project; Vitest for any JS helpers
**Target Platform**: Supabase hosted PostgreSQL
**Project Type**: Web application (database layer only for this feature)
**Performance Goals**: Slug lookups < 10ms; Realtime events < 1 second
**Constraints**: Free tier Supabase, 24h log retention, timeout range 1-55s
**Scale/Scope**: Max 10 endpoints per user (app-enforced), logs auto-cleaned at 24h

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Plain JavaScript, No Exceptions | PASS | Migration files are SQL (not JS). No TypeScript. |
| II. Browser-as-Bridge | PASS | Schema enables Realtime notifications to browser via webhook_logs publication. No alternative relay mechanism introduced. |
| III. Full HTTP Fidelity | PASS | Schema stores complete request/response headers and bodies as-is (jsonb/text). No transformation. custom_headers is additive only per spec. |
| IV. Meaningful Testing | PASS | Acceptance scenarios test constraint enforcement, RLS isolation, Realtime events, and cleanup. No PrimeVue/Tailwind testing involved. |
| V. Simplicity & Minimal Scope | PASS | Only two tables, standard PostgreSQL features (RLS, triggers, pg_cron). No over-engineering. |

**Gate result**: PASS — no violations.

### Post-Phase 1 Re-check

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Plain JavaScript | PASS | All SQL, no JS code in this feature |
| II. Browser-as-Bridge | PASS | Realtime on webhook_logs enables browser push |
| III. Full HTTP Fidelity | PASS | request_headers/body and response_headers/body stored as-is |
| IV. Meaningful Testing | PASS | Data model includes testable constraints and RLS scenarios |
| V. Simplicity | PASS | 4 focused migration files, standard Postgres patterns |

**Gate result**: PASS — no violations.

## Project Structure

### Documentation (this feature)

```text
specs/002-database-schema/
├── plan.md              # This file
├── research.md          # Phase 0: Research decisions
├── data-model.md        # Phase 1: Entity definitions and relationships
├── quickstart.md        # Phase 1: Setup and validation guide
├── contracts/
│   └── database-schema.sql  # Phase 1: SQL contract reference
└── tasks.md             # Phase 2: Generated by /speckit.tasks
```

### Source Code (repository root)

```text
supabase/
└── migrations/
    ├── 20260209000001_create_tables.sql       # Tables, indexes, trigger
    ├── 20260209000002_enable_rls.sql          # RLS enable + policies
    ├── 20260209000003_enable_realtime.sql     # Realtime publication
    └── 20260209000004_setup_cron_cleanup.sql  # pg_cron extension + job
```

**Structure Decision**: This feature only creates SQL migration files in the standard `supabase/migrations/` directory. No application code is modified. The `supabase/` directory does not yet exist and will be created as part of implementation.

## Complexity Tracking

No constitution violations — this section is intentionally empty.
